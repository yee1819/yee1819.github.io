<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Nginx初步认识 | Kirari</title><meta name="author" content="Kirari"><meta name="copyright" content="Kirari"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="初步认识Nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx初步认识">
<meta property="og:url" content="http://example.com/posts/bbc25a0e.html">
<meta property="og:site_name" content="Kirari">
<meta property="og:description" content="初步认识Nginx">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com/%5Cmarkdown20231217_081022.jpg">
<meta property="article:published_time" content="2024-05-29T19:30:26.783Z">
<meta property="article:modified_time" content="2024-05-29T19:34:00.041Z">
<meta property="article:author" content="Kirari">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="前端">
<meta property="article:tag" content="网络">
<meta property="article:tag" content="Nginx">
<meta property="article:tag" content="代理">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com/%5Cmarkdown20231217_081022.jpg"><link rel="shortcut icon" href="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com/%5CmarkdownImage_1702755412321.png"><link rel="canonical" href="http://example.com/posts/bbc25a0e.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"这篇文章距离上一次更新已经过了","messageNext":"天 , 请注意内容是否有效"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Nginx初步认识',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-30 03:34:00'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/fontFamily.css"><link href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/lxgwwenkaiscreen.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/footer_kirari.css"><link rel="stylesheet" href="/css/article_all_index.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com/%5CmarkdownImage_1702755412321.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw far fa-bookmark"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/posts/1ec2913a.html"><i class="fa-fw fas fa-thumbs-up"></i><span> 推荐文章</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-camera"></i><span> 图片</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://music.kiko2568.top"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://life.kiko2568.top/index.php/category/shuoshuo/"><i class="fa-fw fas fa-mug-hot"></i><span> 动态</span></a></li><li><a class="site-page child" href="/Blogtimeline/"><i class="fa-fw fas fa-hourglass-half"></i><span> 博客时光机</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://chat.kiko2568.top/"><i class="fa-fw fas fa-robot"></i><span> KioChat</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://yee-1312555989.cos.ap-guangzhou.myqcloud.com/%5Cmarkdown20231217_081022.jpg')"><nav id="nav"><div class="kirari-nav-box"><span id="blog-info"><a href="/" title="Kirari"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com/%5CmarkdownImage_1702755412321.png"/><span class="site-name">Kirari</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw far fa-bookmark"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/posts/1ec2913a.html"><i class="fa-fw fas fa-thumbs-up"></i><span> 推荐文章</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-camera"></i><span> 图片</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://music.kiko2568.top"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://life.kiko2568.top/index.php/category/shuoshuo/"><i class="fa-fw fas fa-mug-hot"></i><span> 动态</span></a></li><li><a class="site-page child" href="/Blogtimeline/"><i class="fa-fw fas fa-hourglass-half"></i><span> 博客时光机</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://chat.kiko2568.top/"><i class="fa-fw fas fa-robot"></i><span> KioChat</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">Nginx初步认识</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-29T19:30:26.783Z" title="发表于 2024-05-30 03:30:26">2024-05-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-29T19:34:00.041Z" title="更新于 2024-05-30 03:34:00">2024-05-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>20分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Nginx初步认识"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Nginx是一个Web服务器和反向代理服务器，有着高性能，占用内存低、可扩展性高多功能等等一系列优点</p>
<p>功能：充当反向代理服务器，服务器的负载均衡、支持HTTP/HTTPS协议、内置缓存机制，自由设置缓存时间提高需要时间和减少后端服务器负载、有着安全性：控制访问路径、IP白名单、名单和速率限制。</p>
<h2 id="下载以及初步运行"><a href="#下载以及初步运行" class="headerlink" title="下载以及初步运行"></a>下载以及初步运行</h2><p>以Windows为例：</p>
<p>官网下载<a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">nginx：下载</a></p>
<p>因为Nginx初始端口为80，这是所有服务器默认的HTTP端口，在<code>Windows中</code>会被占用从而打不开，首先我们需要修改默认端口，解压Nginx文件夹后打开Nginx路径下的<code>\nginx-1.26.0\conf\nginx.conf</code></p>
<p>映入眼帘的是如下配置（去除注释外）：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他我们先不管，先把视线放在<code>http</code>-&gt;<code>server</code>之中，我们可以看到<code>listen</code>后面跟着80这个数字，listen就是我们想要找到的端口号设置，把这一段修改为任意一个没被占用的端口号即可，我这里修改为90</p>
<p>如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">90</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">	    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    	<span class="section">location</span> = /50x.html &#123;</span><br><span class="line">        	<span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后我们打开<a target="_blank" rel="noopener" href="http://127.0.0.1:90/">127.0.0.1:90</a>就能看见默认生成的Nginx页面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com//blogimage-20240529201310112.webp" alt="默认Nginx"></p>
<p>我们注意到<code>server</code>之中还有好几个配置名字，这些都是什么意思呢？</p>
<p>首先看到<code>listen</code>下的<code>server_name</code>，这个起到设置域名或者IP地址的作用，众所周知localhost就是127.0.0.1,所以我们能在27.0.0.1:90访问到Nginx的初始界面。</p>
<p><code>server_name</code>可以使用域名、IP、通配符、正则表达式、<code>default_server</code>进行匹配，定义服务器的地址，其中default_server修饰是搭配80 或者 443 标记用于指定默认的服务器块，当没有其他服务器块匹配请求的域名时，NGINX将使用这个默认的服务器块 （也可以设置你想展示的默认端口或IP地址 。</p>
<p>接下来就是</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line"><span class="section">location</span> = /50x.html &#123;</span><br><span class="line">    <span class="attribute">root</span>   html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>location</code>后设置访问的是请求，可以使用正则表达式、通配符、地址、文件等等例如<code>/</code>就是请求网址根目录，<code>/50x.html</code>，就是请求<code>127.0.0.1:90/50x.html</code>，<code>&#123;&#125;</code>内的参数<code>root</code>为文件地址，可以是相对路径也可以是绝对地址，<code>index</code>是主页的搜索范围，例如上面的配置中就是在<code>/html/</code>找到<code>index.html</code>或者<code>index.htm</code></p>
<blockquote>
<p>Nginx先判断的并不是请求而是路径，但是可以类似的通过<code>try_files $uri /test.html;</code>把路径变为请求，在下面有讲到…</p>
<p>如果省略后缀名也可以找出来结果</p>
</blockquote>
<p>使用<code>=</code>号的时候，会精准匹配某个准确的字符串</p>
<p>我们观察到root 也就是路径写着是<code>html</code>，那么这个html在哪里呢？我们打开Nginx的文件夹中看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com//blogimage-20240529203147654.webp" alt="html路径"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com//blogimage-20240529203307267.webp" alt="网址`/`或`/50x.html`"></p>
<p>除了这个以外，还有一行<code>error_page   500 502 503 504  /50x.html;</code>，意思是如果发生了 500、502、503、504状态码错误，就跳转到<code>/50x.html</code>界面，用来处理页面错误问题。</p>
<p>了解到这些以后我们来自定义一个配置试试看。</p>
<p>添加配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">        <span class="section">location</span> /test &#123;</span><br><span class="line">            <span class="attribute">root</span> html;</span><br><span class="line">            <span class="comment"># index test.html;</span></span><br><span class="line">            <span class="attribute">try_files</span> <span class="variable">$uri</span> /test.html;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">#此时/test可能会被解析为路径而不是请求，所以需要  try_files  </span></span><br><span class="line">        <span class="section">location</span> = /hello.html &#123;</span><br><span class="line">            <span class="attribute">root</span> html;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意！修改配置后需要重启Nginx！！！</p>
<p><code>try_files 正则表达式或者文件名;</code> 加载查询到的第一个结果</p>
</blockquote>
<p>结果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com//blogimage-20240529211241824.webp" alt="自定义新界面的结果"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com//blogimage-20240530003849843.webp" alt="请求以及缺省后缀名"></p>
<p>编码问题不用在意啦…</p>
<h2 id="配置篇"><a href="#配置篇" class="headerlink" title="配置篇"></a>配置篇</h2><h3 id="1-站点配置"><a href="#1-站点配置" class="headerlink" title="1.站点配置"></a>1.站点配置</h3><p>以我的一个站点配置为例子</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">#默认端口号配置，开启了HTTPS  SSL</span></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2 default_server;</span><br><span class="line">		<span class="attribute">listen</span> 端口号;</span><br><span class="line">    <span class="attribute">server_name</span> kiko2568.top xxx.xx.xx.xx;</span><br><span class="line">    <span class="attribute">index</span> index.php index.html index.htm default.php default.htm default.html;</span><br><span class="line">    <span class="comment">#站点所在目录</span></span><br><span class="line">    <span class="attribute">root</span> /www/wwwroot/kiko2568.top;</span><br><span class="line">    <span class="comment">#CERT-APPLY-CHECK--START</span></span><br><span class="line">    <span class="comment"># 用于SSL证书申请时的文件验证相关配置 -- 请勿删除</span></span><br><span class="line">    <span class="comment">#include 可以引入文件所在的目录下的文件，可以用通配符，正则表达式</span></span><br><span class="line">    <span class="attribute">include</span> /www/server/panel/vhost/nginx/well-known/kiko2568.top.conf;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#CERT-APPLY-CHECK--END</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则</span></span><br><span class="line">    <span class="comment">#error_page 404/404.html;</span></span><br><span class="line">    <span class="comment">#HTTP_TO_HTTPS_START</span></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$server_port</span> !<span class="regexp">~ 443)</span>&#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(/.*)$</span> https://<span class="variable">$host</span><span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#HTTP_TO_HTTPS_END</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span>    /www/server/panel/vhost/cert/kiko2568.top/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>    /www/server/panel/vhost/cert/kiko2568.top/privkey.pem;</span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> xxxxx+xxxxxxxx:xxxxx+xxxxxxxx-xxxxx:xxxxx+xxxxxx:xxx+xxxxxx:xxxxx+xxxxxx:xxxxxxxxxx:xxxxx+xxxx:xSA+3DES:!MD5;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000&quot;</span>;</span><br><span class="line">    <span class="comment">#错误界面</span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">497</span>  https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#SSL-END</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#ERROR-PAGE-START  错误页配置，可以注释、删除或修改</span></span><br><span class="line">    <span class="comment">#error_page 404 /404.html;</span></span><br><span class="line">    <span class="comment">#error_page 502 /502.html;</span></span><br><span class="line">    <span class="comment">#ERROR-PAGE-END</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#PHP-INFO-START  PHP引用配置，可以注释或修改</span></span><br><span class="line">    <span class="attribute">include</span> enable-php-<span class="number">80</span>.conf;</span><br><span class="line">    <span class="comment">#PHP-INFO-END</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#REWRITE-START URL重写规则引用,修改后将导致面板设置的伪静态规则失效</span></span><br><span class="line">    <span class="attribute">include</span> /www/server/panel/vhost/rewrite/kiko2568.top.conf;</span><br><span class="line">    <span class="comment">#REWRITE-END</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#禁止访问的文件或目录</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ ^/(\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">404</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#一键申请SSL证书验证目录相关设置</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ \.well-known</span>&#123;</span><br><span class="line">        <span class="attribute">allow</span> all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#禁止在证书验证目录放入敏感文件</span></span><br><span class="line">    <span class="attribute">if</span> ( <span class="variable">$uri</span> <span class="regexp">~ &quot;^/\.well-known/.*\.(php|jsp|py|js|css|lua|ts|go|zip|tar\.gz|rar|7z|sql|bak)$&quot;</span> ) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">#设置静态资源缓存过期时间 和日志</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attribute">expires</span>      <span class="number">30d</span>;</span><br><span class="line">        <span class="attribute">error_log</span> /dev/null;</span><br><span class="line">        <span class="attribute">access_log</span> /dev/null;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">#设置js||css 文件缓存过期时间 和日志</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ .*\.(js|css)?$</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attribute">expires</span>      <span class="number">12h</span>;</span><br><span class="line">        <span class="attribute">error_log</span> /dev/null;</span><br><span class="line">        <span class="attribute">access_log</span> /dev/null;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#日志存放记录</span></span><br><span class="line">    <span class="attribute">access_log</span>  /www/wwwlogs/kiko2568.top.log;</span><br><span class="line">    <span class="attribute">error_log</span>  /www/wwwlogs/kiko2568.top.<span class="literal">error</span>.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Nginx服务器配置"><a href="#Nginx服务器配置" class="headerlink" title="Nginx服务器配置"></a>Nginx服务器配置</h3><blockquote>
<p>这里我直接转载<a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/nginx-setup-intro.html">Nginx 配置详解 | 菜鸟教程 (runoob.com)</a></p>
<p>他写的好详细！！！</p>
<p>小小偷个懒</p>
</blockquote>
<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...              <span class="comment">#全局块</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;         <span class="comment">#events块</span></span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">http</span>      <span class="comment">#http块</span></span><br><span class="line">&#123;</span><br><span class="line">    ...   <span class="comment">#http全局块</span></span><br><span class="line">    <span class="attribute">server</span>        <span class="comment">#server块</span></span><br><span class="line">    &#123; </span><br><span class="line">        ...       <span class="comment">#server全局块</span></span><br><span class="line">        <span class="section">location</span> [PATTERN]   <span class="comment">#location块</span></span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">location</span> [PATTERN] </span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span></span><br><span class="line">    &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...     <span class="comment">#http全局块</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>1、<strong>全局块</strong>：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。</li>
<li>2、<strong>events块</strong>：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</li>
<li>3、<strong>http块</strong>：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。</li>
<li>4、<strong>server块</strong>：配置虚拟主机的相关参数，一个http中可以有多个server。</li>
<li>5、<strong>location块</strong>：配置请求的路由，以及各种页面的处理情况。</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########### 每个指令必须有分号结束。#################</span></span><br><span class="line"><span class="comment">#user administrator administrators;  #配置用户或者组，默认为nobody nobody。  </span></span><br><span class="line"><span class="comment">#worker_processes 2;  #允许生成的进程数，默认为1   可设置  auto</span></span><br><span class="line"><span class="comment">#pid /nginx/pid/nginx.pid;   #指定nginx进程运行文件存放地址</span></span><br><span class="line"><span class="attribute">error_log</span> log/<span class="literal">error</span>.log <span class="literal">debug</span>;  <span class="comment">#制定日志路径，级别。这个设置可以放入全局块，http块，server块，级别以此为：debug|info|notice|warn|error|crit|alert|emerg</span></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">accept_mutex</span> <span class="literal">on</span>;   <span class="comment">#设置网路连接序列化，防止惊群现象发生，默认为on</span></span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;  <span class="comment">#设置一个进程是否同时接受多个网络连接，默认为off</span></span><br><span class="line">    <span class="comment">#use epoll;      #事件驱动模型，select|poll|kqueue|epoll|resig|/dev/poll|eventport</span></span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;    <span class="comment">#最大连接数，默认为512</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;   <span class="comment">#文件扩展名与文件类型映射表</span></span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream; <span class="comment">#默认文件类型，默认为text/plain</span></span><br><span class="line">    <span class="comment">#access_log off; #取消服务日志    </span></span><br><span class="line">    <span class="attribute">log_format</span> myFormat <span class="string">&#x27;<span class="variable">$remote_addr</span>–<span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] <span class="variable">$request</span> <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> <span class="variable">$http_referer</span> <span class="variable">$http_user_agent</span> <span class="variable">$http_x_forwarded_for</span>&#x27;</span>; <span class="comment">#自定义格式</span></span><br><span class="line">    <span class="attribute">access_log</span> log/access.log myFormat;  <span class="comment">#combined为日志格式的默认值</span></span><br><span class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>;   <span class="comment">#允许sendfile方式传输文件，默认为off，可以在http块，server块，location块。</span></span><br><span class="line">    <span class="attribute">sendfile_max_chunk</span> <span class="number">100k</span>;  <span class="comment">#每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;  <span class="comment">#连接超时时间，默认为75s，可以在http，server，location块。</span></span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> mysvr &#123;   </span><br><span class="line">      <span class="attribute">server</span> <span class="number">127.0.0.1:7878</span>;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.10.121:3333</span> backup;  <span class="comment">#热备</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> https://www.baidu.com; <span class="comment">#错误页</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">keepalive_requests</span> <span class="number">120</span>; <span class="comment">#单连接请求上限次数。</span></span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">4545</span>;   <span class="comment">#监听端口</span></span><br><span class="line">        <span class="attribute">server_name</span>  <span class="number">127.0.0.1</span>;   <span class="comment">#监听地址       </span></span><br><span class="line">        <span class="section">location</span>  ~*^.+$ &#123;       <span class="comment">#请求的url过滤，正则匹配，~为区分大小写，~*为不区分大小写。</span></span><br><span class="line">           <span class="comment">#root path;  #根目录</span></span><br><span class="line">           <span class="comment">#index vv.txt;  #设置默认页</span></span><br><span class="line">           <span class="attribute">proxy_pass</span>  http://mysvr;  <span class="comment">#请求转向mysvr 定义的服务器列表</span></span><br><span class="line">           <span class="attribute">deny</span> <span class="number">127.0.0.1</span>;  <span class="comment">#拒绝的ip</span></span><br><span class="line">           <span class="attribute">allow</span> <span class="number">172.18.5.54</span>; <span class="comment">#允许的ip           </span></span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面是nginx的基本配置，需要注意的有以下几点：</p>
<p>1、几个常见配置项：</p>
<ul>
<li>1.$remote_addr 与 $http_x_forwarded_for 用以记录客户端的ip地址；</li>
<li>2.$remote_user ：用来记录客户端用户名称；</li>
<li>3.$time_local ： 用来记录访问时间与时区；</li>
<li>4.$request ： 用来记录请求的url与http协议；</li>
<li>5.$status ： 用来记录请求状态；成功是200；</li>
<li>6.$body_bytes_s ent ：记录发送给客户端文件主体内容大小；</li>
<li>7.$http_referer ：用来记录从那个页面链接访问过来的；</li>
<li>8.$http_user_agent ：记录客户端浏览器的相关信息；</li>
</ul>
<p>2、惊群现象：一个网路连接到来，多个睡眠的进程被同时叫醒，但只有一个进程能获得链接，这样会影响系统性能。</p>
<p>3、每个指令必须有分号结束。</p>
<hr>
<h2 id="代理、正向代理以及反向代理"><a href="#代理、正向代理以及反向代理" class="headerlink" title="代理、正向代理以及反向代理"></a>代理、正向代理以及反向代理</h2><p>代理：通过第三方（第一第二方为服务器端和客户端）服务器来进行代理，让服务器端和客户端不直接碰面，从而成功请求响应数据。</p>
<h3 id="正向代理："><a href="#正向代理：" class="headerlink" title="正向代理："></a>正向代理：</h3><p>forward proxy</p>
<p>代理的是客户端，去和服务器端交互</p>
<p>客户端给代理服务器发送请求，由代理服务器转发给服务器端，并把响应的内容转发回客户端</p>
<p>用处：</p>
<ul>
<li><p><strong>突破访问限制</strong> </p>
<p>类似vpn，使用不属于本地网络来访问不能访问的地方</p>
</li>
<li><p><strong>提高访问速度</strong></p>
<p>通常代理服务器都设置一个较大的硬盘缓冲区，会将部分请求的响应保存到缓冲区中，当其他用户再访问相同的信息时， 则直接由缓冲区中取出信息，传给用户，以提高访问速度。</p>
</li>
<li><p><strong>隐藏客户端真实IP</strong></p>
<p>服务器端交互 的是代理服务器而不是客户端，起到了隐藏的作用</p>
</li>
</ul>
<h3 id="反向代理："><a href="#反向代理：" class="headerlink" title="反向代理："></a>反向代理：</h3><p><strong>reverse proxy</strong></p>
<p>代理的是服务器端，去和客户端交互</p>
<p>作为伪装的服务器端接受请求把请求转发给服务器端，并假装服务器端把真正的服务器响应的数据给客户端</p>
<p>用处：</p>
<ul>
<li><strong>隐藏服务器真实IP</strong><br>使用反向代理，可以对客户端隐藏服务器的IP地址。</li>
</ul>
<ul>
<li><strong>负载均衡</strong><br>反向代理服务器可以做负载均衡，根据所有真实服务器的负载情况，将客户端请求分发到不同的真实服务器上。</li>
</ul>
<ul>
<li><strong>提高访问速度</strong><br>反向代理服务器可以对于静态内容及短时间内有大量访问请求的动态内容提供缓存服务，提高访问速度。</li>
</ul>
<ul>
<li><strong>提供安全保障</strong><br>反向代理服务器可以作为应用层防火墙，为网站提供对基于Web的攻击行为（例如DoS/DDoS）的防护，更容易排查恶意软件等。还可以为后端服务器统一提供加密和SSL加速（如SSL终端代理），提供HTTP访问认证等。</li>
</ul>
<h3 id="Nginx设置代理"><a href="#Nginx设置代理" class="headerlink" title="Nginx设置代理"></a>Nginx设置代理</h3><h4 id="设置-404-页面导向地址"><a href="#设置-404-页面导向地址" class="headerlink" title="设置 404 页面导向地址"></a>设置 404 页面导向地址</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> https://www.error.com; <span class="comment">#错误页</span></span><br><span class="line"><span class="attribute">proxy_intercept_errors</span> <span class="literal">on</span>;    <span class="comment">#如果被代理服务器返回的状态码为400或者大于400，设置的error_page配置起作用。默认为off。</span></span><br></pre></td></tr></table></figure>
<h4 id="如果我们的代理只允许接受get，post请求方法的一种"><a href="#如果我们的代理只允许接受get，post请求方法的一种" class="headerlink" title="如果我们的代理只允许接受get，post请求方法的一种"></a>如果我们的代理只允许接受get，post请求方法的一种</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_method</span> get;    <span class="comment">#支持客户端的请求方法。post/get；</span></span><br></pre></td></tr></table></figure>
<h4 id="设置支持的http协议版本"><a href="#设置支持的http协议版本" class="headerlink" title="设置支持的http协议版本"></a>设置支持的http协议版本</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">0</span> ; <span class="comment">#Nginx服务器提供代理服务的http协议版本1.0，1.1,默认设置为1.0版本</span></span><br></pre></td></tr></table></figure>
<p>设置HTTP2</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2; <span class="comment">#设置前端2.0 443接口支持 http2以及SSL</span></span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /path/to/your/certificate.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /path/to/your/private.key;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>; <span class="comment">#后端还是1.1 </span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在 Nginx 配置中，即使前端使用的是 HTTP/2，与后端服务器的通信通常仍然使用 HTTP/1.1。原因在于，HTTP/2 的主要优点（如多路复用、头部压缩和服务器推送）主要体现在客户端和 Nginx 之间的通信中。Nginx 作为反向代理服务器，可以将前端的 HTTP/2 请求转换为后端的 HTTP/1.1 请求，这样可以确保与后端服务器的兼容性和稳定性。</p>
<h4 id="负载均衡时，某服务器超时-连接失败-时不再请求"><a href="#负载均衡时，某服务器超时-连接失败-时不再请求" class="headerlink" title="负载均衡时，某服务器超时/连接失败 时不再请求"></a>负载均衡时，某服务器超时/连接失败 时不再请求</h4><p>例如有俩个服务器A，B，B连接不上了，这个时候再发送给B请求就会超时，等待响应时间长，才把重新请求发给A，可以断开链接</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_connect_timeout</span> <span class="number">1</span>;   <span class="comment">#nginx服务器与被代理的服务器建立连接的超时时间，默认60秒</span></span><br><span class="line"><span class="attribute">proxy_read_timeout</span> <span class="number">1</span>; <span class="comment">#nginx服务器想被代理服务器组发出read请求后，等待响应的超时间，默认为60秒。</span></span><br><span class="line"><span class="attribute">proxy_send_timeout</span> <span class="number">1</span>; <span class="comment">#nginx服务器想被代理服务器组发出write请求后，等待响应的超时间，默认为60秒。</span></span><br><span class="line"><span class="attribute">proxy_ignore_client_abort</span> <span class="literal">on</span>;  <span class="comment">#客户端断网时，nginx服务器是否终端对被代理服务器的请求。默认为off。</span></span><br></pre></td></tr></table></figure>
<h4 id="负载均衡时设置异常情况切换下一个服务器"><a href="#负载均衡时设置异常情况切换下一个服务器" class="headerlink" title="负载均衡时设置异常情况切换下一个服务器"></a>负载均衡时设置异常情况切换下一个服务器</h4><p>如果使用upstream指令配置一组服务器作为被代理服务器，服务器中的访问算法遵循配置的负载均衡规则，同时可以使用该指令配置在发生哪些异常情况时，将请求顺次交由下一组服务器处理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_next_upstream timeout;  #反向代理upstream中设置的服务器组，出现故障时，被代理服务器返回的状态值。</span><br></pre></td></tr></table></figure>
<p>状态值可以是：</p>
<ul>
<li>error：建立连接或向被代理的服务器发送请求或读取响应信息时服务器发生错误。</li>
<li>timeout：建立连接，想被代理服务器发送请求或读取响应信息时服务器发生超时。</li>
<li>invalid_header:被代理服务器返回的响应头异常。</li>
<li>off:无法将请求分发给被代理的服务器。</li>
<li>http_400，http_500|http_502|http_503|http_504|http_404….:被代理服务器返回的状态码为400，500，502，等。</li>
</ul>
<h4 id="获取客户端真实信息而不是代理服务器"><a href="#获取客户端真实信息而不是代理服务器" class="headerlink" title="获取客户端真实信息而不是代理服务器"></a>获取客户端真实信息而不是代理服务器</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>; <span class="comment">#只要用户在浏览器中访问的域名绑定了 VIP VIP 下面有RS；则就用$host ；host是访问URL中的域名和端口  www.taobao.com:80</span></span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;  <span class="comment">#把源IP 【$remote_addr,建立HTTP连接header里面的信息】赋值给X-Real-IP;这样在代码中 $X-Real-IP来获取 源IP</span></span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;<span class="comment">#在nginx 作为代理服务器时，设置的IP列表，会把经过的机器ip，代理机器ip都记录下来，用 【，】隔开；代码中用 echo $x-forwarded-for |awk -F, &#x27;&#123;print $1&#125;&#x27; 来作为源IP</span></span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>; <span class="comment">#将客户端使用的协议（http 或 https）传递给后端服务器。</span></span><br></pre></td></tr></table></figure>
<h4 id="反向代理：-1"><a href="#反向代理：-1" class="headerlink" title="反向代理："></a>反向代理：</h4><p>和下面的负载均衡一样</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">0.0.0.1</span>;</span><br><span class="line">    <span class="comment">#....还可以再加</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="配置大全"><a href="#配置大全" class="headerlink" title="配置大全"></a>配置大全</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">include</span>       mime.types;   <span class="comment">#文件扩展名与文件类型映射表</span></span><br><span class="line"><span class="attribute">default_type</span>  application/octet-stream; <span class="comment">#默认文件类型，默认为text/plain</span></span><br><span class="line"><span class="comment">#access_log off; #取消服务日志    </span></span><br><span class="line"><span class="attribute">log_format</span> myFormat <span class="string">&#x27; <span class="variable">$remote_addr</span>–<span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] <span class="variable">$request</span> <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> <span class="variable">$http_referer</span> <span class="variable">$http_user_agent</span> <span class="variable">$http_x_forwarded_for</span>&#x27;</span>; <span class="comment">#自定义格式</span></span><br><span class="line"><span class="attribute">access_log</span> log/access.log myFormat;  <span class="comment">#combined为日志格式的默认值</span></span><br><span class="line"><span class="attribute">sendfile</span> <span class="literal">on</span>;   <span class="comment">#允许sendfile方式传输文件，默认为off，可以在http块，server块，location块。</span></span><br><span class="line"><span class="attribute">sendfile_max_chunk</span> <span class="number">100k</span>;  <span class="comment">#每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。</span></span><br><span class="line"><span class="attribute">keepalive_timeout</span> <span class="number">65</span>;  <span class="comment">#连接超时时间，默认为75s，可以在http，server，location块。</span></span><br><span class="line"><span class="attribute">proxy_connect_timeout</span> <span class="number">1</span>;   <span class="comment">#nginx服务器与被代理的服务器建立连接的超时时间，默认60秒</span></span><br><span class="line"><span class="attribute">proxy_read_timeout</span> <span class="number">1</span>; <span class="comment">#nginx服务器想被代理服务器组发出read请求后，等待响应的超时间，默认为60秒。</span></span><br><span class="line"><span class="attribute">proxy_send_timeout</span> <span class="number">1</span>; <span class="comment">#nginx服务器想被代理服务器组发出write请求后，等待响应的超时间，默认为60秒。</span></span><br><span class="line"><span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">0</span> ; <span class="comment">#Nginx服务器提供代理服务的http协议版本1.0，1.1，默认设置为1.0版本。</span></span><br><span class="line"><span class="comment">#proxy_method get;    #支持客户端的请求方法。post/get；</span></span><br><span class="line"><span class="attribute">proxy_ignore_client_abort</span> <span class="literal">on</span>;  <span class="comment">#客户端断网时，nginx服务器是否终端对被代理服务器的请求。默认为off。</span></span><br><span class="line"><span class="attribute">proxy_ignore_headers</span> <span class="string">&quot;Expires&quot;</span> <span class="string">&quot;Set-Cookie&quot;</span>;  <span class="comment">#Nginx服务器不处理设置的http相应投中的头域，这里空格隔开可以设置多个。</span></span><br><span class="line"><span class="attribute">proxy_intercept_errors</span> <span class="literal">on</span>;    <span class="comment">#如果被代理服务器返回的状态码为400或者大于400，设置的error_page配置起作用。默认为off。</span></span><br><span class="line"><span class="attribute">proxy_headers_hash_max_size</span> <span class="number">1024</span>; <span class="comment">#存放http报文头的哈希表容量上限，默认为512个字符。</span></span><br><span class="line"><span class="attribute">proxy_headers_hash_bucket_size</span> <span class="number">128</span>; <span class="comment">#nginx服务器申请存放http报文头的哈希表容量大小。默认为64个字符。</span></span><br><span class="line"><span class="attribute">proxy_next_upstream</span> timeout;  <span class="comment">#反向代理upstream中设置的服务器组，出现故障时，被代理服务器返回的状态值。error|timeout|invalid_header|http_500|http_502|http_503|http_504|http_404|off</span></span><br><span class="line"><span class="comment">#proxy_ssl_session_reuse on; 默认为on，如果我们在错误日志中发现“SSL3_GET_FINSHED:digest check failed”的情况时，可以将该指令设置为off。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>用户多的时候，执行业务处理中的服务器免不了高并发，如果只有一个服务器，那么可能导致响应速度慢业务堵塞服务器崩溃等等不好的后果。所以一般会由多个服务器进行业务处理，降低每个服务器的压力。</p>
<p>具体使用</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">upstream</span> backend &#123;</span><br><span class="line">        <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">        <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">0.0.0.1</span>;</span><br><span class="line">        <span class="comment">#....还可以再加</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，服务器就有原本的一个服务器支撑业务就变为多个服务器一起进行</p>
<h3 id="轮询-Round-Robin"><a href="#轮询-Round-Robin" class="headerlink" title="轮询 (Round Robin):"></a><strong>轮询 (Round Robin)</strong>:</h3><p>默认的算法：例如设置了三个服务器进行负载均衡，则按照顺序一个一个轮流分配请求到每个后端服务器。</p>
<p>例如a、b、c为三个服务器 的编号，现在有一连串的请求到Nginx，那么分配顺序就是：abc abc abc abc abc</p>
<h3 id="权重-Weight"><a href="#权重-Weight" class="headerlink" title="权重 (Weight):"></a><strong>权重 (Weight)</strong>:</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com weight=<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com weight=<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">0.0.0.1</span> weight=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置方法就是在IP地址后面加上  weight= 权重值 ，不设置默认为1</p>
<p>如代码所示，a、b、c的权重为3、2、1那么一串请求进入的分配结果为：</p>
<p>aaabbc  aaabbc    aaabbc </p>
<h3 id="IP-哈希-IP-Hash"><a href="#IP-哈希-IP-Hash" class="headerlink" title="IP 哈希 (IP Hash):"></a><strong>IP 哈希 (IP Hash)</strong>:</h3><p>根据客户端 IP 地址的哈希值来分配请求，这样来自同一个客户端的请求会始终被分配到同一个后端服务器。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">0.0.0.1</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请求的session就不怕被分配到其他的服务器了。</p>
<h3 id="热备（backup）"><a href="#热备（backup）" class="headerlink" title="热备（backup）"></a><strong>热备（backup）</strong></h3><p>设置某个 服务器 做当作备用，当全部服务器都故障了，就使用这个备用服务器。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> mysvr &#123; </span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">0.0.0.1</span>  backup;  <span class="comment">#热备     </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加入a、b是编号，b是热备，那么请求是这样的aaaaaaaaaa，a 故障了，bbbbbbbbb。</p>
<h3 id="健康检查-Health-Check"><a href="#健康检查-Health-Check" class="headerlink" title="健康检查 (Health Check):"></a><strong>健康检查 (Health Check)</strong>:</h3><p>为了确保请求只被分配到正常运行的服务器，可以配置健康检查。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com weight=<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com weight=<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">0.0.0.1</span> weight=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">health_check</span> interval=<span class="number">10s</span> fails=<span class="number">3</span> passes=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>三个参数为：</p>
<ul>
<li><p><strong>interval=10s</strong>:<br>表示健康检查的时间间隔，即每 10 秒对每个上游服务器进行一次健康检查。</p>
</li>
<li><p><strong>fails=3</strong>:<br>表示在标记服务器为不可用之前必须连续失败的健康检查次数。如果服务器连续 3 次健康检查失败，那么它将被认为是不可用的。</p>
</li>
<li><p><strong>passes=2</strong>:<br>表示在将服务器标记为可用之前必须连续成功的健康检查次数。如果服务器被标记为不可用，但之后连续 2 次健康检查成功，那么它将被重新标记为可用。</p>
</li>
</ul>
<h3 id="最少连接-Least-Connections"><a href="#最少连接-Least-Connections" class="headerlink" title="最少连接 (Least Connections):"></a><strong>最少连接 (Least Connections)</strong>:</h3><p> 将请求分配给当前活动连接数最少的服务器，适用于请求处理时间较长的场景。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">0.0.0.1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><ul>
<li>down，表示当前的server暂时不参与负载均衡。</li>
<li>backup，预留的备份机器。当其他所有的非backup机器出现故障或者忙的时候，才会请求backup机器，因此这台机器的压力最轻。</li>
<li>max_fails，允许请求失败的次数，默认为1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误。</li>
<li>fail_timeout，在经历了max_fails次失败后，暂停服务的时间。max_fails可以和fail_timeout一起使用。</li>
</ul>
<p>例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> mysvr &#123; </span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:7878</span> weight=<span class="number">2</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.10.121:3333</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">1</span>;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>参考</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/nginx-proxy-balancing.html">Nginx 反向代理与负载均衡详解 | 菜鸟教程 (runoob.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/464965616">深入理解 http 反向代理（nginx） - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/381967653">运维排查篇 | 访问nginx出现403错误 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1418457">终于有人把正向代理和反向代理解释的明明白白了！-腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/david_xtd/article/details/16967837">写给Web开发人员看的Nginx介绍_ngnix和服务器语言-CSDN博客</a></p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Kirari</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/posts/bbc25a0e.html">http://example.com/posts/bbc25a0e.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Kirari</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a><a class="post-meta__tags" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C/">网络</a><a class="post-meta__tags" href="/tags/Nginx/">Nginx</a><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%90%86/">代理</a></div><div class="post_share"><div class="social-share" data-image="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com/%5Cmarkdown20231217_081022.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2022a644.html" title="油猴脚本初体验"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com/%5Cmarkdown20231217_081022.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">油猴脚本初体验</div></div></a></div><div class="next-post pull-right"><a href="/posts/be3f90b4.html" title="Meavn入门"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yee-1312555989.cos.ap-guangzhou.myqcloud.com/%5Cmarkdown20231217_081022.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Meavn入门</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E4%BB%A5%E5%8F%8A%E5%88%9D%E6%AD%A5%E8%BF%90%E8%A1%8C"><span class="toc-number">2.</span> <span class="toc-text">下载以及初步运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%AF%87"><span class="toc-number">3.</span> <span class="toc-text">配置篇</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">1.站点配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.</span> <span class="toc-text">Nginx服务器配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">3.2.1.</span> <span class="toc-text">目录结构</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E3%80%81%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E4%BB%A5%E5%8F%8A%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">代理、正向代理以及反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%EF%BC%9A"><span class="toc-number">4.1.</span> <span class="toc-text">正向代理：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%EF%BC%9A"><span class="toc-number">4.2.</span> <span class="toc-text">反向代理：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86"><span class="toc-number">4.3.</span> <span class="toc-text">Nginx设置代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-404-%E9%A1%B5%E9%9D%A2%E5%AF%BC%E5%90%91%E5%9C%B0%E5%9D%80"><span class="toc-number">4.3.1.</span> <span class="toc-text">设置 404 页面导向地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E7%9A%84%E4%BB%A3%E7%90%86%E5%8F%AA%E5%85%81%E8%AE%B8%E6%8E%A5%E5%8F%97get%EF%BC%8Cpost%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95%E7%9A%84%E4%B8%80%E7%A7%8D"><span class="toc-number">4.3.2.</span> <span class="toc-text">如果我们的代理只允许接受get，post请求方法的一种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E6%94%AF%E6%8C%81%E7%9A%84http%E5%8D%8F%E8%AE%AE%E7%89%88%E6%9C%AC"><span class="toc-number">4.3.3.</span> <span class="toc-text">设置支持的http协议版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%97%B6%EF%BC%8C%E6%9F%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%B6%85%E6%97%B6-%E8%BF%9E%E6%8E%A5%E5%A4%B1%E8%B4%A5-%E6%97%B6%E4%B8%8D%E5%86%8D%E8%AF%B7%E6%B1%82"><span class="toc-number">4.3.4.</span> <span class="toc-text">负载均衡时，某服务器超时&#x2F;连接失败 时不再请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%97%B6%E8%AE%BE%E7%BD%AE%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%E5%88%87%E6%8D%A2%E4%B8%8B%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.3.5.</span> <span class="toc-text">负载均衡时设置异常情况切换下一个服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9C%9F%E5%AE%9E%E4%BF%A1%E6%81%AF%E8%80%8C%E4%B8%8D%E6%98%AF%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.3.6.</span> <span class="toc-text">获取客户端真实信息而不是代理服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%EF%BC%9A-1"><span class="toc-number">4.3.7.</span> <span class="toc-text">反向代理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%A4%A7%E5%85%A8"><span class="toc-number">4.3.8.</span> <span class="toc-text">配置大全</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.</span> <span class="toc-text">负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AE%E8%AF%A2-Round-Robin"><span class="toc-number">5.1.</span> <span class="toc-text">轮询 (Round Robin):</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%87%8D-Weight"><span class="toc-number">5.2.</span> <span class="toc-text">权重 (Weight):</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP-%E5%93%88%E5%B8%8C-IP-Hash"><span class="toc-number">5.3.</span> <span class="toc-text">IP 哈希 (IP Hash):</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E5%A4%87%EF%BC%88backup%EF%BC%89"><span class="toc-number">5.4.</span> <span class="toc-text">热备（backup）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5-Health-Check"><span class="toc-number">5.5.</span> <span class="toc-text">健康检查 (Health Check):</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%B0%91%E8%BF%9E%E6%8E%A5-Least-Connections"><span class="toc-number">5.6.</span> <span class="toc-text">最少连接 (Least Connections):</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE"><span class="toc-number">5.7.</span> <span class="toc-text">其他配置</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: rgb(0,0,0,0)"><div id="footer-wrap"><div id="footer-bar-links"><div id="footer_left"><div class="copyright">&copy;2023 - 2024 By <a target="_blank" rel="noopener" href="https://kiko2568.top">Kirari</a></div><span class="footer-separator">|</span><div class="framework-info"><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><div id="footer_right"><div class="footer_custom_text"><a href="https://icp.gov.moe/?keyword=20232568" target="_blank">萌ICP备20232568号</a>|<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/shouye.html">桂ICP备2024029447号-1</a></div></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-comments-tau.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(init)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-comments-tau.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
      
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/randomTopImg.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>